//
//  ContentView.swift
//  Example
//
//  Created by Daehoon Kim on 7/21/25.
//

import SwiftUI
import MonetaiSDK
import RevenueCat

struct ContentView: View {
    @StateObject private var monetaiSDK = MonetaiSDK.shared
    @State private var isInitialized = false
    @State private var predictionResult: String = ""
    @State private var isLoading = false
    @State private var packages: [Package] = []
    @State private var customerInfo: CustomerInfo?
    @State private var initializationResult: String = ""
    @State private var initializationError: String = ""
    @State private var discountStatus: String = ""
    
    private let sdkKey = Constants.sdkKey
    private let userId = Constants.userId
    private let useStoreKit2 = Constants.useStoreKit2
    
    // RevenueCat API Keys
    private let revenueCatAPIKey = Constants.revenueCatAPIKey
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 20) {
                    // Header
                    headerSection
                    
                    // StoreKit Version Info
                    storeKitInfoSection
                    
                    // Available Products
                    productsSection
                    
                    // Customer Information
                    customerInfoSection
                    
                    // Discount Information
                    discountInfoSection
                    
                    // MonetaiSDK Actions
                    monetaiActionsSection
                }
                .padding()
            }
            .navigationTitle("Monetai Example")
            .onAppear {
                initializeSDKs()
                setupDiscountInfoListener()
            }
        }
    }
    
    private func setupDiscountInfoListener() {
        // Set up automatic discount information update callback for Monetai SDK
        monetaiSDK.onDiscountInfoChange = { discount in
            Task { @MainActor in
                if let discount = discount {
                    let isActive = discount.endedAt > Date()
                    discountStatus = isActive ?
                        "‚úÖ Active until \(discount.endedAt.formatted(date: .abbreviated, time: .shortened))" :
                        "‚ùå Expired on \(discount.endedAt.formatted(date: .abbreviated, time: .shortened))"
                } else {
                    discountStatus = "No discount available"
                }
            }
        }
    }
    
    // MARK: - Header Section
    private var headerSection: some View {
        VStack(spacing: 12) {
            Text("Monetai Example App")
                .font(.title2)
                .fontWeight(.bold)
                .foregroundColor(.primary)
            
            HStack {
                Text("Status:")
                    .foregroundColor(.secondary)
                
                HStack(spacing: 8) {
                    Circle()
                        .fill(isInitialized ? Color.green : Color.red)
                        .frame(width: 8, height: 8)
                    
                    Text(isInitialized ? "Connected" : "Connecting...")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            
            // Display initialization result
            if !initializationResult.isEmpty {
                Text(initializationResult)
                    .font(.caption)
                    .foregroundColor(.primary)
                    .padding(.horizontal, 12)
                    .padding(.vertical, 8)
                    .background(Color.green.opacity(0.1))
                    .cornerRadius(8)
                    .multilineTextAlignment(.leading)
            }
            
            // Display initialization error
            if !initializationError.isEmpty {
                Text(initializationError)
                    .font(.caption)
                    .foregroundColor(.red)
                    .padding(.horizontal, 12)
                    .padding(.vertical, 8)
                    .background(Color.red.opacity(0.1))
                    .cornerRadius(8)
                    .multilineTextAlignment(.leading)
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(radius: 2)
    }
    
    // MARK: - StoreKit Info Section
    private var storeKitInfoSection: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("RevenueCat + StoreKit")
                .font(.headline)
                .foregroundColor(.primary)
            
            Text("StoreKit \(useStoreKit2 ? "2" : "1") via RevenueCat")
                .font(.subheadline)
                .foregroundColor(.blue)
                .fontWeight(.medium)
        }
        .frame(maxWidth: .infinity, alignment: .leading)
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(8)
    }
    
    // MARK: - Products Section
    private var productsSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("Available Products")
                .font(.headline)
                .foregroundColor(.primary)
            
            if packages.isEmpty {
                VStack {
                    ProgressView()
                        .scaleEffect(0.8)
                    Text("Loading products...")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color(.systemBackground))
                .cornerRadius(8)
            } else {
                ForEach(packages, id: \.identifier) { package in
                    ProductRow(package: package) {
                        await purchasePackage(package)
                    }
                }
            }
        }
    }
    
    // MARK: - Customer Info Section
    private var customerInfoSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("Customer Information")
                .font(.headline)
                .foregroundColor(.primary)
            
            if let customerInfo = customerInfo,
               !customerInfo.entitlements.active.isEmpty {
                VStack(alignment: .leading, spacing: 8) {
                    Text("Active Entitlements")
                        .font(.subheadline)
                        .fontWeight(.medium)
                    
                    ForEach(Array(customerInfo.entitlements.active.keys), id: \.self) { key in
                        if let entitlement = customerInfo.entitlements.active[key] {
                            EntitlementRow(key: key, entitlement: entitlement)
                        }
                    }
                }
            } else {
                VStack(spacing: 8) {
                    Image(systemName: "creditcard")
                        .font(.title2)
                        .foregroundColor(.secondary)
                    
                    Text("No active subscriptions found")
                        .font(.subheadline)
                        .fontWeight(.medium)
                        .foregroundColor(.secondary)
                    
                    Text("Purchase a product to see your subscription details here")
                        .font(.caption)
                        .foregroundColor(.secondary)
                        .multilineTextAlignment(.center)
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color(.systemBackground))
                .cornerRadius(8)
            }
        }
    }
    
    // MARK: - Discount Information Section
    private var discountInfoSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("üí∞ Discount Information")
                .font(.headline)
                .foregroundColor(.primary)
            
            if let discount = monetaiSDK.currentDiscount {
                let isActive = discount.endedAt > Date()
                
                VStack(alignment: .leading, spacing: 8) {
                    HStack {
                        Text("üéØ Status:")
                            .font(.subheadline)
                            .fontWeight(.medium)
                        Spacer()
                        Text(isActive ? "üü¢ Active" : "üî¥ Expired")
                            .font(.subheadline)
                            .fontWeight(.medium)
                            .foregroundColor(isActive ? .green : .red)
                    }
                    
                    HStack {
                        Text("üë§ User ID:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text(discount.appUserId)
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("‚è∞ Started:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text(discount.startedAt.formatted(date: .abbreviated, time: .shortened))
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("‚è≥ Expires:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text(discount.endedAt.formatted(date: .abbreviated, time: .shortened))
                            .font(.caption)
                            .foregroundColor(isActive ? .orange : .red)
                    }
                    
                    if isActive {
                        let timeRemaining = discount.endedAt.timeIntervalSince(Date())
                        let totalSeconds = Int(timeRemaining)
                        let hours = totalSeconds / 3600
                        let minutes = (totalSeconds % 3600) / 60
                        
                        HStack {
                            Text("‚è±Ô∏è Time Left:")
                                .font(.caption)
                                .fontWeight(.medium)
                            Spacer()
                            Text("\(hours)h \(minutes)m")
                                .font(.caption)
                                .foregroundColor(.orange)
                                .fontWeight(.medium)
                        }
                    }
                }
                .padding(.horizontal, 12)
                .padding(.vertical, 10)
                .background(isActive ? Color.green.opacity(0.1) : Color.red.opacity(0.1))
                .cornerRadius(8)
            } else {
                VStack(spacing: 8) {
                    Image(systemName: "tag.slash")
                        .font(.title2)
                        .foregroundColor(.secondary)
                    
                    Text("No active discount")
                        .font(.subheadline)
                        .fontWeight(.medium)
                        .foregroundColor(.secondary)
                    
                    Text(discountStatus.isEmpty ? "Use 'Predict User' to check for available discounts" : discountStatus)
                        .font(.caption)
                        .foregroundColor(.secondary)
                        .multilineTextAlignment(.center)
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color(.systemGray6))
                .cornerRadius(8)
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(radius: 2)
    }
    
    // MARK: - MonetaiSDK Actions Section
    private var monetaiActionsSection: some View {
        VStack(alignment: .leading, spacing: 12) {
            Text("Monetai SDK Actions")
                .font(.headline)
                .foregroundColor(.primary)
            
            // Test Events Section
            VStack(spacing: 8) {
                Text("Test Events")
                    .font(.subheadline)
                    .fontWeight(.medium)
                    .foregroundColor(.secondary)
                
                VStack(spacing: 8) {
                    HStack(spacing: 8) {
                        Button("App Opened") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "app_opened")
                                print("‚úÖ [TEST] app_opened event log request")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                        
                        Button("Product Viewed") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "product_viewed")
                                print("‚úÖ [TEST] product_viewed event log request")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                    }
                    .frame(maxWidth: .infinity)
                    
                    HStack(spacing: 8) {
                        Button("Add to Cart") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "add_to_cart", params: ["value": 9.99])
                                print("‚úÖ [TEST] add_to_cart event log request (value: 9.99)")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                        
                        Button("Purchase Started") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "purchase_started", params: ["value": 19.99])
                                print("‚úÖ [TEST] purchase_started event log request (value: 19.99)")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                    }
                    .frame(maxWidth: .infinity)
                    
                    // New params-based events
                    Text("New Params Events")
                        .font(.caption)
                        .fontWeight(.medium)
                        .foregroundColor(.blue)
                        .padding(.top, 8)
                    
                    HStack(spacing: 8) {
                        Button("Screen View") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "screen_view", params: [
                                    "screen_name": "home",
                                    "previous_screen": "onboarding"
                                ])
                                print("‚úÖ [TEST] screen_view event log request (params)")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                        
                        Button("Button Click") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "button_click", params: [
                                    "button_name": "upgrade",
                                    "location": "header",
                                    "experiment_id": "exp_123"
                                ])
                                print("‚úÖ [TEST] button_click event log request (params)")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                    }
                    .frame(maxWidth: .infinity)
                    
                    HStack(spacing: 8) {
                        Button("Feature Used") {
                            Task {
                                await monetaiSDK.logEvent(eventName: "feature_used", params: [
                                    "feature_name": "premium_filter",
                                    "usage_count": 5,
                                    "is_premium_user": false
                                ])
                                print("‚úÖ [TEST] feature_used event log request (params)")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                        
                        Button("LogEventOptions") {
                            Task {
                                let options = LogEventOptions(
                                    eventName: "custom_event",
                                    params: [
                                        "category": "test",
                                        "timestamp": Date().timeIntervalSince1970,
                                        "user_level": 10
                                    ]
                                )
                                await monetaiSDK.logEvent(options)
                                print("‚úÖ [TEST] Event log request using LogEventOptions")
                            }
                        }
                        .buttonStyle(TestButtonStyle())
                    }
                    .frame(maxWidth: .infinity)
                }
            }
            
            // Prediction Section
            Button(action: {
                Task {
                    await predictUser()
                }
            }) {
                HStack {
                    if isLoading {
                        ProgressView()
                            .scaleEffect(0.8)
                            .foregroundColor(.white)
                    }
                    
                    Text("Predict User")
                        .fontWeight(.medium)
                }
            }
            .buttonStyle(ActionButtonStyle())
            .disabled(isLoading || !isInitialized)
            
            if !predictionResult.isEmpty {
                VStack(alignment: .leading, spacing: 4) {
                    Text("Prediction Result:")
                        .font(.caption)
                        .fontWeight(.medium)
                        .foregroundColor(.secondary)
                    
                    Text(predictionResult)
                        .font(.subheadline)
                        .fontWeight(.medium)
                        .foregroundColor(predictionResult.contains("Error") ? .red : .blue)
                        .padding(.horizontal, 12)
                        .padding(.vertical, 8)
                        .background(Color(.systemGray6))
                        .cornerRadius(8)
                }
            }
            
            // SDK Status Info (Detailed)
            VStack(alignment: .leading, spacing: 8) {
                Text("SDK Status Details:")
                    .font(.subheadline)
                    .fontWeight(.medium)
                    .foregroundColor(.primary)
                
                VStack(alignment: .leading, spacing: 6) {
                    HStack {
                        Text("üîß Initialized:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text(isInitialized ? "‚úÖ YES" : "‚ùå NO")
                            .font(.caption)
                            .foregroundColor(isInitialized ? .green : .red)
                    }
                    
                    HStack {
                        Text("üîë SDK Key:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text("\(sdkKey.prefix(12))...")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("üë§ User ID:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text(userId)
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("üõí StoreKit:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text("Version \(useStoreKit2 ? "2" : "1")")
                            .font(.caption)
                            .foregroundColor(.blue)
                    }
                    
                    HStack {
                        Text("üì± Platform:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text("iOS Native")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                    
                    HStack {
                        Text("üåê Server:")
                            .font(.caption)
                            .fontWeight(.medium)
                        Spacer()
                        Text(isInitialized ? "üü¢ Connected" : "üî¥ Disconnected")
                            .font(.caption)
                            .foregroundColor(isInitialized ? .green : .red)
                    }
                    
                    if let exposureTimeSec = monetaiSDK.exposureTimeSec {
                        HStack {
                            Text("‚è±Ô∏è Exposure Time:")
                                .font(.caption)
                                .fontWeight(.medium)
                            Spacer()
                            Text("\(exposureTimeSec) sec")
                                .font(.caption)
                                .foregroundColor(.orange)
                        }
                    }
                }
                .padding(.horizontal, 12)
                .padding(.vertical, 8)
                .background(Color(.systemGray6))
                .cornerRadius(8)
            }
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(12)
        .shadow(radius: 2)
    }
    
    // MARK: - Helper Methods
    private func initializeSDKs() {
        Task {
            // üß™ Test logging for pending events before SDK initialization
            print("üß™ [PENDING EVENTS TEST] Starting event logging before SDK initialization...")
            
            await monetaiSDK.logEvent(eventName: "app_launched", params: [
                "launch_time": Date().timeIntervalSince1970,
                "version": "1.0.0",
                "device": "iOS"
            ])
            
            await monetaiSDK.logEvent(eventName: "app_background_to_foreground", params: [
                "session_start": true,
                "user_type": "example_user"
            ])
            
            await monetaiSDK.logEvent(eventName: "feature_accessed", params: [
                "feature": "monetai_example",
                "access_method": "direct_launch"
            ])
            
            print("üß™ [PENDING EVENTS TEST] 3 events logged before SDK initialization")
            print("üß™ [PENDING EVENTS TEST] Now initializing SDK to verify pending events are sent...")
            
            do {
                // Initialize RevenueCat
                Purchases.logLevel = .verbose
                Purchases.configure(with: .builder(withAPIKey: revenueCatAPIKey)
                    .with(appUserID: userId)
                    .with(storeKitVersion: useStoreKit2 ? .storeKit2 : .storeKit1)
                    .build()
                )
                
                print("üöÄ [SDK] Starting Monetai SDK initialization...")
                
                // Initialize MonetaiSDK
                let result = try await monetaiSDK.initialize(
                    sdkKey: sdkKey,
                    userId: userId,
                    useStoreKit2: useStoreKit2
                )
                
                print("üéâ [SDK] Monetai SDK initialization complete!")
                
                await MainActor.run {
                    isInitialized = true
                    initializationResult = """
                    ‚úÖ Monetai SDK initialization successful!
                    
                    üìä Initialization result:
                    ‚Ä¢ Organization ID: \(result.organizationId)
                    ‚Ä¢ Platform: \(result.platform)
                    ‚Ä¢ Version: \(result.version)
                    ‚Ä¢ User ID: \(result.userId)
                    ‚Ä¢ Test Group: \(result.group?.stringValue ?? "None")
                    
                    üéØ Status: Ready
                    üß™ Pending Events: 3 events before initialization sent automatically
                    """
                    initializationError = ""
                }
                
                // Log initialization event (sent immediately after SDK initialization)
                await monetaiSDK.logEvent(eventName: "monetai_initialized", params: [
                    "initialization_time": Date().timeIntervalSince1970,
                    "test_group": result.group?.stringValue ?? "none"
                ])
                
                // Load products
                await loadProducts()
                
                // Load customer info
                await loadCustomerInfo()
                
                print("MonetaiSDK initialized successfully: \(result)")
                
            } catch {
                await MainActor.run {
                    isInitialized = false
                    initializationError = """
                    ‚ùå Monetai SDK initialization failed

                    üö® Error details:
                    \(error.localizedDescription)
                    
                    üîß ÌôïÏù∏ ÏÇ¨Ìï≠:
                    ‚Ä¢ SDK ÌÇ§Í∞Ä Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏
                    ‚Ä¢ ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
                    ‚Ä¢ ÏÑúÎ≤Ñ ÏÉÅÌÉú ÌôïÏù∏
                    """
                    initializationResult = ""
                }
                print("Failed to initialize SDKs: \(error)")
            }
        }
    }
    
    private func loadProducts() async {
        do {
            let offerings = try await Purchases.shared.offerings()
            
            await MainActor.run {
                if let currentOffering = offerings.current {
                    self.packages = currentOffering.availablePackages
                } else {
                    // Fallback: Í∏∞Î≥∏ Ìå®ÌÇ§ÏßÄÎì§ Î°úÎìú
                    self.packages = offerings.all.values.flatMap { $0.availablePackages }
                }
            }
        } catch {
            print("Failed to load products: \(error)")
        }
    }
    
    private func loadCustomerInfo() async {
        do {
            let customerInfo = try await Purchases.shared.customerInfo()
            await MainActor.run {
                self.customerInfo = customerInfo
            }
        } catch {
            print("Failed to load customer info: \(error)")
        }
    }
    
    private func purchasePackage(_ package: Package) async {
        print("üõí [PURCHASE] Íµ¨Îß§ ÏãúÏûë: \(package.storeProduct.productIdentifier)")
        print("üõí [PURCHASE] Ï†úÌíà Ï†ïÎ≥¥: \(package.storeProduct.localizedTitle) - \(package.localizedPriceString)")
        
        do {
            print("üõí [PURCHASE] RevenueCat purchase() Ìò∏Ï∂ú...")
            let (transaction, customerInfo, userCancelled) = try await Purchases.shared.purchase(package: package)
            
            print("üõí [PURCHASE] Íµ¨Îß§ ÏôÑÎ£å!")
            print("üõí [PURCHASE] Transaction: \(transaction?.debugDescription ?? "nil")")
            print("üõí [PURCHASE] Transaction ID: \(transaction?.transactionIdentifier ?? "nil")")
            print("üõí [PURCHASE] Product ID: \(transaction?.productIdentifier ?? "nil")")
            print("üõí [PURCHASE] User cancelled: \(userCancelled)")
            print("üõí [PURCHASE] Customer ID: \(customerInfo.originalAppUserId)")
            print("üõí [PURCHASE] Active entitlements count: \(customerInfo.entitlements.active.count)")
            print("üõí [PURCHASE] Active entitlements: \(customerInfo.entitlements.active.keys.joined(separator: ", "))")
            
            // userCancelledÍ∞Ä trueÏù∏ Í≤ΩÏö∞ ÏÑ±Í≥µÏúºÎ°ú Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏùå
            if userCancelled {
                print("üõí [PURCHASE] ÏÇ¨Ïö©ÏûêÍ∞Ä Íµ¨Îß§Î•º Ï∑®ÏÜåÌñàÏäµÎãàÎã§.")
                return
            }
            
            await MainActor.run {
                self.customerInfo = customerInfo
                print("üõí [PURCHASE] UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å")
            }
            
            print("‚úÖ Purchase successful: \(package.storeProduct.productIdentifier)")
            
        } catch {
            print("‚ùå Purchase failed: \(error)")
            print("‚ùå Error details: \(error.localizedDescription)")
            print("‚ùå Error type: \(type(of: error))")
            
            // RevenueCat ÏóêÎü¨ ÌÉÄÏûÖÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
            if let rcError = error as? RevenueCat.ErrorCode {
                print("‚ùå RevenueCat Error Code: \(rcError.rawValue)")
                print("‚ùå RevenueCat Error Description: \(rcError.description)")
            }
            
            // NSErrorÎ°ú Ï∫êÏä§ÌåÖÌï¥ÏÑú Îçî ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥ ÌôïÏù∏
            if let nsError = error as NSError? {
                print("‚ùå NSError domain: \(nsError.domain)")
                print("‚ùå NSError code: \(nsError.code)")
                print("‚ùå NSError userInfo: \(nsError.userInfo)")
            }
            
            // RevenueCat ÏóêÎü¨ Ï∂îÍ∞Ä Ï†ïÎ≥¥
            print("‚ùå Error mirror: \(String(reflecting: error))")
            
            // ÏóêÎü¨Î•º Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌï¥ÏÑú Îçî ÎßéÏùÄ Ï†ïÎ≥¥ ÌôïÏù∏
            let errorString = String(describing: error)
            print("‚ùå Error description: \(errorString)")
        }
    }
    

    
    private func predictUser() async {
        await MainActor.run {
            isLoading = true
        }
        
        do {
            let result = try await monetaiSDK.predict()
            await MainActor.run {
                predictionResult = result.prediction?.stringValue ?? "Unknown"
                isLoading = false
            }
            
            // SDKÍ∞Ä ÏûêÎèôÏúºÎ°ú Ìï†Ïù∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÍ≥† ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎØÄÎ°ú Î≥ÑÎèÑ Ìò∏Ï∂ú Î∂àÌïÑÏöî
            
        } catch {
            await MainActor.run {
                predictionResult = "Error: \(error.localizedDescription)"
                isLoading = false
            }
        }
    }

}

// MARK: - Supporting Views
struct ProductRow: View {
    let package: Package
    let onPurchase: () async -> Void
    
    var body: some View {
        HStack {
            VStack(alignment: .leading, spacing: 4) {
                Text(package.storeProduct.localizedTitle)
                    .font(.subheadline)
                    .fontWeight(.medium)
                    .foregroundColor(.primary)
                
                Text(package.localizedPriceString)
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            
            Spacer()
            
            Button("Buy") {
                print("üõí [UI] Buy Î≤ÑÌäº ÌÅ¥Î¶≠Îê®: \(package.storeProduct.productIdentifier)")
                Task {
                    print("üõí [UI] onPurchase ÏΩúÎ∞± Ìò∏Ï∂ú Ï§ë...")
                    await onPurchase()
                    print("üõí [UI] onPurchase ÏΩúÎ∞± ÏôÑÎ£å")
                }
            }
            .buttonStyle(BuyButtonStyle())
        }
        .padding()
        .background(Color(.systemBackground))
        .cornerRadius(8)
        .shadow(radius: 1)
    }
}

struct EntitlementRow: View {
    let key: String
    let entitlement: EntitlementInfo
    
    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            HStack {
                Text(key)
                    .font(.caption)
                    .fontWeight(.medium)
                    .foregroundColor(.blue)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 2)
                    .background(Color.blue.opacity(0.1))
                    .cornerRadius(4)
                
                Spacer()
            }
            
            HStack {
                Text("Expiration:")
                    .font(.caption)
                    .foregroundColor(.secondary)
                
                Text(entitlement.expirationDate?.formatted() ?? "Lifetime")
                    .font(.caption)
                    .fontWeight(.medium)
                    .foregroundColor(.primary)
            }
        }
        .padding()
        .background(Color(.systemGray6))
        .cornerRadius(8)
    }
}

// MARK: - Button Styles
struct ActionButtonStyle: ButtonStyle {
    func makeBody(configuration: Self.Configuration) -> some View {
        configuration.label
            .font(.subheadline)
            .fontWeight(.medium)
            .foregroundColor(.white)
            .frame(maxWidth: .infinity)
            .padding(.vertical, 12)
            .background(Color.blue)
            .cornerRadius(8)
            .scaleEffect(configuration.isPressed ? 0.95 : 1.0)
            .animation(.easeInOut(duration: 0.1), value: configuration.isPressed)
    }
}

struct TestButtonStyle: ButtonStyle {
    func makeBody(configuration: Self.Configuration) -> some View {
        configuration.label
            .font(.caption)
            .fontWeight(.medium)
            .foregroundColor(.blue)
            .padding(.horizontal, 12)
            .padding(.vertical, 6)
            .background(Color.blue.opacity(0.1))
            .cornerRadius(6)
            .scaleEffect(configuration.isPressed ? 0.95 : 1.0)
            .animation(.easeInOut(duration: 0.1), value: configuration.isPressed)
    }
}

struct BuyButtonStyle: ButtonStyle {
    func makeBody(configuration: Self.Configuration) -> some View {
        configuration.label
            .font(.caption)
            .fontWeight(.medium)
            .foregroundColor(.white)
            .padding(.horizontal, 16)
            .padding(.vertical, 8)
            .background(Color.green)
            .cornerRadius(6)
            .scaleEffect(configuration.isPressed ? 0.95 : 1.0)
            .animation(.easeInOut(duration: 0.1), value: configuration.isPressed)
    }
}

//#Preview {
//    ContentView()
//}
